<h1 name="content" align="center"><a href=""></a> MSSQL</h1>

<p align="center">
  <a href="#lab1"><img alt="lab1" src="https://img.shields.io/badge/Lab1-800000"></a> 
  <a href="#lab2"><img alt="lab2" src="https://img.shields.io/badge/Lab2-A52A2A"></a>
  <a href="#lab3"><img alt="lab3" src="https://img.shields.io/badge/Lab3-C04000"></a>
  <a href="#lab4"><img alt="lab4" src="https://img.shields.io/badge/Lab4-D2691E"></a>
  <a href="#lab5"><img alt="lab5" src="https://img.shields.io/badge/Lab5-E9967A"></a>
  <a href="#lab6"><img alt="lab6" src="https://img.shields.io/badge/Lab6-F5B78E"></a> 
  <a href="#lab7"><img alt="lab7" src="https://img.shields.io/badge/Lab7-FFDAB9"></a>
  <a href="#lab8"><img alt="lab8" src="https://img.shields.io/badge/Lab8-FFFACD"></a>
</a> 
</p>

<h3 align="center">
  <a href="#client"></a>
Вариант №9: Автоматизация супермаркета
</h3>

Возможные варианты сущностей:
- Товары: код, название товара, цена продажи, закупочная цена, единица измерения (шт., кг.), производитель, дата производства, срок годности, количество
- Карточки, выданные покупателям: Код карточки, размер скидки в %
- Корзина: Товары, которые набрал покупатель и предъявляет к оплате на кассе, дата покупки, фамилия кассира

Реализовать:
- Вывод товаров с истекшим сроком годности
- Подсчет выручки супермаркета за заданный период
- Подсчет стоимости корзины
- Определение скидки для корзины (если предъявлена карта, сумму уменьшаем на размер скидки; если карта не предъявлена и если сумма > 2000руб., выписываем карту со скидкой 4%, если сумма > 500руб., выписываем карту 2%)

<a id="lab1"></a>
# Лабораторная работа №1
[Назад](#content)

Разработать ER-модель данной предметной области: выделить сущности, их атрибуты, связи между сущностями. 
Для каждой сущности указать ее имя, атрибут (или набор атрибутов), являющийся первичным ключом, список остальных атрибутов.
Для каждого атрибута указать его тип, ограничения, может ли он быть пустым, является ли он первичным ключом.

Для каждой связи между сущностями указать: 
- тип связи (1:1, 1:M, M:N)
- обязательность

ER-модель д.б. представлена в виде ER-диаграммы (картинка)
По имеющейся ER-модели создать реляционную модель данных и отобразить её в виде списка сущностей с их атрибутами и типами атрибутов,  для атрибутов указать, является ли он первичным или внешним ключом 

<h3>
1.1. ER-модель
  
![image](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%201/er_model.png)
</h3>
<h3>
1.2. Реляционная модель

![image](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%201/реляционная%20модель.png)
</h3>

<a id="lab2"></a>
# Лабораторная работа №2
[Назад](#content)

В соответствии с реляционной моделью данных, разработанной в Лаб.№1, создать реляционную БД на учебном сервере БД:
- создать таблицы, определить первичные ключи и иные ограничения
- определить связи между таблицами
- создать диаграмму
- заполнить все таблицы адекватной информацией (не меньше 10 записей в таблицах, наличие примеров для связей типа 1:M)

<h3> 
  
2.1. [SQL-код создания таблиц](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%202/Query_Supermarket.sql)
</h3>

<h3>
2.2. Диаграмма БД "Supermarket"
  
![image](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%202/diagram_supermarket.png)
</h3>

<h3>
2.3. Примеры заполненных таблиц
</h3>

  1) "Товар":
     
![image](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%202/table_products.png)

  3) "Покупатель":
     
![image](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%202/table_customer.png)

  3) "Покупка":
     
 ![image](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%202/table_sale.png)



<a id="lab3"></a>
# Лабораторная работа №3
[Назад](#content)

<h3>
  
3.1. [SQL-код создания запросов](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%203/Lab3_Query.sql)
</h3>
  
<h3>
  
3.2. [Docx-файл с описанием запросов](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%203/Лаб№3%20КрыловаК.docx)
</h3>

-

[Часть 1. Цель: изучить конструкции языка SQL для манипулирования данными в СУБД  MSSQL.](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%203/Лаб№3%20часть%201.pdf)

1. Выборка из одной таблицы
   
  1) Выбрать из произвольной таблицы данные и отсортировать их по двум  произвольным имеющимся в таблице признакам (разные направления сортировки).
     
  2) Выбрать из произвольной таблицы те записи, которые удовлетворяют условию отбора (where). Привести 2-3 запроса.

  3) Привести примеры 2-3 запросов с использованием агрегатных функций(count, max, sum и др.) с группировкой и без группировки. 

  4) Привести примеры подведения подытога с использованием GROUP BY [ALL] [ CUBE | ROLLUP](2-3 запроса). В ROLLUP и CUBE использовать не менее 2-х столбцов.

  5) Выбрать из таблиц информацию об объектах, в названиях которых нет заданной последовательности букв (LIKE).

2. Выборка из нескольких таблиц 

  1) Вывести информацию подчиненной (дочерней) таблицы, заменяя коды (значения внешних ключей) соответствующими символьными значениями из родительских таблиц. Привести 2-3 запроса с использованием классического подхода соединения таблиц (where).

  2) Реализовать запросы пункта 2.1 через внутреннее соединение inner join. 

  3) Левое внешнее соединение left join. Привести 2-3 запроса.

  4) Правое внешнее соединение right join. Привести 2-3 запроса 

  5) Привести примеры 2-3 запросов с использованием агрегатных функций и группировки.

  6) Привести примеры 2-3 запросов с использованием группировки и условия отбора групп (Having).

  7) Привести примеры 3-4 вложенных (соотнесенных, c использованием IN, EXISTS) запросов.

#### 3. Представления

3.1.  На основе любых запросов из п. 2 создать два представления (VIEW).

3.2. Привести примеры использования общетабличных выражений (СТЕ) (2-3 запроса)

#### 4. Функции ранжирования

4.1. Привести примеры 3-4 запросов с использованием ROW_NUMBER, RANK, DENSE_RANK (c  PARTITION BY и без)

#### 5. Объединение, пересечение, разность

5.1. Привести примеры 3-4 запросов с использованием UNION / UNION ALL, EXCEPT, INTERSECT. Данные  в одном из запросов отсортируйте по произвольному признаку.

#### 6. Использование CASE, PIVOT и UNPIVOT

6.1. Привести примеры получения сводных (итоговых) таблиц с использованием CASE

6.2. Привести примеры получения сводных (итоговых) таблиц с использованием PIVOT и UNPIVOT.

---

### [Часть 2. Составить следующие запросы:](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%203/Лаб№3%20часть%202.pdf)

a) Найти товары, у которых срок годности заканчивается сегодня

b) Вывести все скидки, которые используются с супермаркете, и количество карт с этим % скидки

c) Подсчитать для каждого % скидки количество карточек, предъявленных за вчерашний день и вывести в виде:

| Процент | 0% | 2% | 4% |
| :--- | :--- | :--- | :--- |
| Количество | ... | ... | ... |

d)  Вывести список товаров, проданных за сегодня, их количество и суммарную стоимость

e)  Подсчитать выручку супермаркета с начала текущего месяца

<a id="lab4"></a>
# Лабораторная работа №4
[Назад](#content)
<h3>
  
4.1. [SQL-код создания запросов](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%204/Lab4_Query.sql)
</h3>
  
<h3>
  
4.2. [Docx-файл с описанием запросов](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%204/Лаб№4%20КрыловаК.docx)
</h3>

---
#### [Создать  4 различных хранимых процедуры:](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%204/Лаб№4%20процедуры.pdf)

a) Процедура без параметров, формирующая список товаров с истекшим сроком годности;
  
b) Процедура, которая для заданной корзины формирует список лежащих в ней товаров в виде: название, количество, дата производства;
  
c) Процедура, на входе получающая % скидки для карты, выходной параметр – количество карт с этой скидкой, по которым были сделаны покупки более чем на 1 000 р.;
  
d) Процедура, вызывающая вложенную процедуру, которая находит за последний год день с наибольшей выручкой. Главная процедура подсчитывает прибыль супермаркета за этот день (прибыль = выручка-суммарная закупочная стоимость товаров).
  
#### [Создать 3 пользовательских функции:](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%204/Лаб№4%20функции.pdf)

a) Скалярная функция, подсчитывающая прибыль супермаркета за заданный период;
  
b) Inline-функция, по заданной карте возвращающая список производителей товаров, которые когда-либо покупались владельцем карты;
  
c) Multi-statement-функция, выдающая список карт, суммарная стоимость покупок по которым превысила 10 000р., в виде: номер карты, % скидки, общая сумма покупок по карте.

#### [Создать 3 триггера:](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%204/Лаб№4%20триггеры.pdf)

a) Триггер любого типа на добавление корзины – если сумма товаров > 500р. и нет карты, то добавляем карту с 2%-ной скидкой, если сумма > 2000р. и нет карты, то добавляем карту с 4%-ной скидкой, если сумма > 2000р. и карта есть, то устанавливаем скидку в 4%;
  
b)  Последующий триггер на изменение цены продажи товара – если цена продажи меньше, чем закупочная цена, изменение отменяется, выводится соотв. сообщение;
  
c) Замещающий триггер на операцию удаления – при удалении товара из корзины (возврат товара) вернуть его в супермаркет, пересчитать стоимость корзины.
  
Обязательно предусмотреть обработку НЕСКОЛЬКИХ записей! (там, где необходимо, использовать КУРСОР!)

<a id="lab5"></a>
# Лабораторная работа №5
[Назад](#content)
<h3 align="left">
  <a href="#client"></a>
  Создание ролей и присвоение им прав на объекты БД
</h3>

### [Задание 1](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%205/Создание%20пользователей%20и%20ролей.sql)

Для БД, созданной в Лаб.раб. 1-2, создать 2 роли.

- 1-я роль должна иметь доступ к таблицам, хр. процедурам и др. объектам БД, требующийся для руководителя фирмы (зав. библиотекой, столовой, дет.садом, поликлиникой, ...) (т.е., ему д.б. разрешено просматривать конфиденциальную информацию, удалять, исправлять какие-то сведения, выполнять процедуры и функции). Некоторые права необходимо предоставить с возможностью дальнейшей передачи.
- 2-я роль должна иметь доступ, требующийся для простого сотрудника (просмотр не всей инф-ии, добавление, изменение, удаление – только того, что нужно для работы, выполнение
ограниченного набора процедур и функции).
- Включить 2-х пользователей, предварительно созданных для каждого студента администратором БД (User_<ваш логин>, User1_<ваш логин>, Пароль - 1234567), в эти роли и проверить, что права
ролей выполняются для каждого пользователя (для этого под каждым пользователем подключиться к БД).

Необходимо уметь предоставлять права на объекты любого типа, отзывать выданные права, давать полный запрет на выполнение некоторых действий. (через команды T-SQL и интерфейс SQL Server Management Studio (SSMS))

### [Задание 2](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%205/Маскирование.sql)

Выполнить маскирование некоторых полей Ваших таблиц 2-мя различными методами:
- ALTER COLUMN LastName ADD MASKED WITH (FUNCTION = 'partial(2,"xxxx",0)')
- Используя механизмы представлений, хранимых процедур и функций.
   
Члены 1 роли должны видеть оригинальные данные, члены 2 роли маскированные. В качестве отчета по этой ЛР предоставить скрипт, выполняющий эти действия.

<a id="lab6"></a>
# Лабораторная работа №6
[Назад](#content)
<h3 align="left">
  <a href="#client"></a>
   Создание графовых таблиц и работа с ними
</h3>

Используя реляционную БД из лабораторной работы №2:
- Продумайте и создайте графовые таблицы по реляционной БД.
- Заполните графовые таблицы используя данные в реляционных таблицах.
- Напишите запросы из задания 3.2 используя паттерн MATCH.
- Сравните полученные результаты с результатами запросов к реляционной модели.

<h3> 
6.1. Схема узлов и рёбер 

![image](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%206/Графовая%20модель.png)
</h3>

<h3>
  
6.2. [SQL-код создания и заполнения графовых таблиц](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%206/Создание%20графовых%20таблиц.sql)
</h3>

<h3>

  6.3. [SQL-запросы из задания 3.2 к двум моделям (реляционная, графовая)](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%206/Сравнение%20запросов.sql)
</h3>

<h3>

  6.4. [Сравнение запросов](https://github.com/Ksunchiks/Lab_databases/blob/main/Lab%206/Сравнение%20запросов.pdf)
</h3>

<a id="lab7"></a>
# Лабораторная работа №7
[Назад](#content)
<h3 align="left">
  <a href="#client"></a>
</h3>
